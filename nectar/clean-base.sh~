#!/bin/bash

uniq=`date +%Y%m%d%H%M%S`

idir=/var/lib/nova/instances
vinst=/tmp/virsh-inst.$uniq
used_disk=/tmp/used_disks.$uniq

ls $idir |grep -v _base |grep -v compute_nodes |grep -v libvirt-save |grep -v locks |grep -v lost+found |grep -v snapshots > $vinst

for i in `cat $vinst`;do qemu-img info /var/lib/nova/instances/$i/disk |grep backing|awk '{print $3}';done > $used_disk

for i in `cat $vinst`;do qemu-img info /var/lib/nova/instances/$i/disk.local |grep backing|awk '{print $3}';done >> $used_disk
#mv $
